const express = require('express');
const bodyParser = require('body-parser');
const bcrypt = require('bcryptjs');
const { v4: uuidv4 } = require('uuid');
const multer = require('multer');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static('public'));
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// In-memory "database" (for now)
let users = [];
let sessions = {}; // userId -> session info

// File upload config
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    const userDir = path.join(__dirname, 'storage', req.session.userId);
    if (!fs.existsSync(userDir)) {
      fs.mkdirSync(userDir, { recursive: true });
    }
    cb(null, userDir);
  },
  filename: function (req, file, cb) {
    cb(null, file.originalname);
  }
});
const upload = multer({ storage: storage });

// Session simulation (super basic)
app.use((req, res, next) => {
  req.session = sessions[req.headers['x-user-id']] || null;
  next();
});

// Routes

// Home
app.get('/', (req, res) => {
  if (!req.session) return res.redirect('/login');
  res.redirect('/dashboard');
});

// Signup Page
app.get('/signup', (req, res) => {
  res.render('signup');
});

// Handle Signup
app.post('/signup', async (req, res) => {
  const { username, email, password } = req.body;
  const existingUser = users.find(u => u.email === email);
  if (existingUser) return res.send('Email already registered.');

  const hashedPassword = await bcrypt.hash(password, 10);
  const newUser = { id: uuidv4(), username, email, password: hashedPassword };
  users.push(newUser);

  res.redirect('/login');
});

// Login Page
app.get('/login', (req, res) => {
  res.render('login');
});

// Handle Login
app.post('/login', async (req, res) => {
  const { email, password } = req.body;
  const user = users.find(u => u.email === email);
  if (!user) return res.send('Invalid email or password.');

  const validPassword = await bcrypt.compare(password, user.password);
  if (!validPassword) return res.send('Invalid email or password.');

  const sessionId = uuidv4();
  sessions[sessionId] = { userId: user.id, username: user.username };

  res.set('x-user-id', sessionId);
  res.redirect('/dashboard');
});

// Dashboard
app.get('/dashboard', (req, res) => {
  if (!req.session) return res.redirect('/login');
  res.render('dashboard', { username: req.session.username });
});

// Upload File
app.post('/upload', upload.single('file'), (req, res) => {
  if (!req.session) return res.redirect('/login');
  res.redirect('/dashboard');
});

// Logout
app.get('/logout', (req, res) => {
  if (!req.session) return res.redirect('/login');
  delete sessions[req.headers['x-user-id']];
  res.redirect('/login');
});

// Start Server
app.listen(PORT, () => {
  console.log(`ðŸ”¥ Swift Fix server running at http://localhost:${PORT}`);
});
